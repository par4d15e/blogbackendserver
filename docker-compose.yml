services:
  app:
    image: ningli3739/server:latest
    container_name: server
    working_dir: /server
    restart: unless-stopped
    command: ["bash", "/server/script/setup-server.sh"]
    volumes:
      - /opt/server/secret:/server/secret:ro
      - static_files:/server/static
      - /opt/server/alembic:/server/alembic
      - /opt/server/alembic.ini:/server/alembic.ini
      - /opt/server/initial_data.py:/server/script/initial_data.py:ro
    ports:
      - "8000:8000"
    # Memory config: optimized for 2GB RAM server (workers controlled via env vars)
    # Note: deploy.resources only works in Docker Swarm mode
    # For regular docker-compose, resource usage is controlled via UVICORN_WORKERS
    environment:
      - UVICORN_WORKERS=2
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://0.0.0.0:8000/docs || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s
    networks:
      - server_network

  nginx:
    image: nginx:latest
    container_name: nginx
    restart: unless-stopped
    network_mode: host
    volumes:
      - /opt/server/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - static_files:/server/static:ro
    # Nginx typically uses minimal memory (~20-50MB), no special limits needed
    # Note: When using network_mode: host, depends_on service_healthy condition may not work properly
    # Therefore, only wait for service to start, don't check health status
    depends_on:
      app:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "nginx -t"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  static_files:

networks:
  server_network:
    driver: bridge
