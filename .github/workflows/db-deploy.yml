name: Deploy DB Server

on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  deploy-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare script file
        run: |
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶åˆ°å·¥ä½œç›®å½•æ ¹ç›®å½•ï¼Œé¿å… SCP ä¿ç•™ç›®å½•ç»“æ„
          cp script/setup-mysql-redis.sh setup-mysql-redis.sh
          ls -lh setup-mysql-redis.sh

      - name: Upload script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          source: "setup-mysql-redis.sh"
          target: "/tmp/"

      - name: Verify file upload
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          script: |
            echo "ğŸ” éªŒè¯æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šä¼ ..."
            echo "ğŸ“‹ /tmp/ ç›®å½•å®Œæ•´å†…å®¹ï¼š"
            ls -la /tmp/

            # æ£€æŸ¥æ–‡ä»¶å¯èƒ½çš„ä½ç½®
            if [ -f /tmp/setup-mysql-redis.sh ]; then
              echo "âœ… æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ° /tmp/setup-mysql-redis.sh"
              ls -lh /tmp/setup-mysql-redis.sh
            elif [ -f /tmp/script/setup-mysql-redis.sh ]; then
              echo "âš ï¸  æ–‡ä»¶åœ¨ /tmp/script/setup-mysql-redis.shï¼Œç§»åŠ¨åˆ° /tmp/"
              sudo mv /tmp/script/setup-mysql-redis.sh /tmp/setup-mysql-redis.sh
              sudo rmdir /tmp/script 2>/dev/null || true
              echo "âœ… æ–‡ä»¶å·²ç§»åŠ¨åˆ° /tmp/setup-mysql-redis.sh"
            else
              echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼šæœªæ‰¾åˆ° setup-mysql-redis.sh"
              echo "ğŸ“‹ é€’å½’æŸ¥æ‰¾ setup-mysql-redis.shï¼š"
              find /tmp -name "setup-mysql-redis.sh" 2>/dev/null || echo "æœªæ‰¾åˆ°"
              exit 1
            fi

      - name: Setup SSH and execute
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          envs: APP_SERVER_IP,MYSQL_ROOT_PASS,MYSQL_APP_USER,MYSQL_APP_PASS,REDIS_PASS
          script: |
            # è°ƒè¯•ï¼šåˆ—å‡º /tmp/ ç›®å½•å†…å®¹
            echo "ğŸ“ æ£€æŸ¥ /tmp/ ç›®å½•å†…å®¹ï¼š"
            ls -la /tmp/ | grep -E "setup-mysql-redis|total" || echo "æœªæ‰¾åˆ° setup-mysql-redis.sh"

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f /tmp/setup-mysql-redis.sh ]; then
              echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ /tmp/setup-mysql-redis.sh ä¸å­˜åœ¨"
              echo "ğŸ“‹ /tmp/ ç›®å½•å®Œæ•´å†…å®¹ï¼š"
              ls -la /tmp/
              exit 1
            fi

            echo "âœ… æ–‡ä»¶ /tmp/setup-mysql-redis.sh å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ..."

            # APP_SERVER_IP: åº”ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œç”¨äºé…ç½® MySQL ç”¨æˆ·å…è®¸è¿æ¥çš„ IP å’Œé˜²ç«å¢™è§„åˆ™
            export APP_SERVER_IP="${{ secrets.APP_SERVER_IP }}"
            export MYSQL_ROOT_PASS="${{ secrets.MYSQL_ROOT_PASS }}"
            export MYSQL_APP_USER="${{ secrets.MYSQL_APP_USER }}"
            export MYSQL_APP_PASS="${{ secrets.MYSQL_APP_PASS }}"

            sudo mv /tmp/setup-mysql-redis.sh /opt/setup-mysql-redis.sh
            sudo chmod +x /opt/setup-mysql-redis.sh
            sudo -E bash /opt/setup-mysql-redis.sh
