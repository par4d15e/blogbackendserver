name: Deploy DB Server

on:
  push:
    branches:
      - main

jobs:
  deploy-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare script file
        run: |
          cp script/setup-mysql-redis.sh setup-mysql-redis.sh
          ls -lh setup-mysql-redis.sh

      - name: Upload script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          source: "setup-mysql-redis.sh"
          target: "/tmp/"

      - name: Verify file upload
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          script: |
            echo "Verifying file upload..."
            echo "Contents of /tmp/:"
            ls -la /tmp/

            if [ -f /tmp/setup-mysql-redis.sh ]; then
              echo "File uploaded to /tmp/setup-mysql-redis.sh"
              ls -lh /tmp/setup-mysql-redis.sh
            elif [ -f /tmp/script/setup-mysql-redis.sh ]; then
              echo "File at /tmp/script/, moving to /tmp/"
              sudo mv /tmp/script/setup-mysql-redis.sh /tmp/setup-mysql-redis.sh
              sudo rmdir /tmp/script 2>/dev/null || true
              echo "File moved to /tmp/setup-mysql-redis.sh"
            else
              echo "Upload failed: setup-mysql-redis.sh not found"
              echo "Searching for file:"
              find /tmp -name "setup-mysql-redis.sh" 2>/dev/null || echo "Not found"
              exit 1
            fi

      - name: Setup SSH and execute
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DB_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DB_SSH_KEY }}
          envs: APP_SERVER_IP,MYSQL_ROOT_PASS,MYSQL_APP_USER,MYSQL_APP_PASS,REDIS_PASS
          script: |
            echo "Checking /tmp/ contents:"
            ls -la /tmp/ | grep -E "setup-mysql-redis|total" || echo "setup-mysql-redis.sh not found"

            if [ ! -f /tmp/setup-mysql-redis.sh ]; then
              echo "Error: /tmp/setup-mysql-redis.sh does not exist"
              echo "/tmp/ contents:"
              ls -la /tmp/
              exit 1
            fi

            echo "File exists, continuing..."

            export APP_SERVER_IP="${{ secrets.APP_SERVER_IP }}"
            export MYSQL_ROOT_PASS="${{ secrets.MYSQL_ROOT_PASS }}"
            export MYSQL_APP_USER="${{ secrets.MYSQL_APP_USER }}"
            export MYSQL_APP_PASS="${{ secrets.MYSQL_APP_PASS }}"

            sudo mv /tmp/setup-mysql-redis.sh /opt/setup-mysql-redis.sh
            sudo chmod +x /opt/setup-mysql-redis.sh
            sudo -E bash /opt/setup-mysql-redis.sh
