name: Deploy App Server

on:
  workflow_run:
    workflows: ["Deploy DB Server"]
    types:
      - completed
    branches:
      - main

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/server
  DEPLOY_DIR: /opt/server
  HEALTH_CHECK_URL: https://api.heyxiaoli.com/docs
  MAX_HEALTH_CHECK_ATTEMPTS: 6
  HEALTH_CHECK_INTERVAL: 5

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      # ========================================
      # 1. ä»£ç å‡†å¤‡é˜¶æ®µ
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # éªŒè¯å¿…è¦æ–‡ä»¶å­˜åœ¨
      - name: Verify required files
        run: |
          echo "ğŸ” Verifying deployment files..."

          REQUIRED_FILES=(
            "docker-compose.yml"
            "nginx.conf"
            "alembic.ini"
            "alembic/env.py"
            "script/initial_data.py"
          )

          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ] && [ ! -d "${file%/*}" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "âŒ Missing required files:"
            printf '   - %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi

          # æ£€æŸ¥è¿ç§»æ–‡ä»¶
          if [ -d "alembic/versions" ]; then
            MIGRATION_COUNT=$(find alembic/versions -name "*.py" -not -name "__init__.py" | wc -l)
            echo "âœ… Found $MIGRATION_COUNT migration file(s)"
            
            if [ "$MIGRATION_COUNT" -eq 0 ]; then
              echo "âš ï¸  Warning: No migration files found"
              echo "   First deployment will auto-generate migrations"
            fi
          else
            echo "âš ï¸  alembic/versions directory not found"
          fi

          echo "âœ… All required files verified"

      # ========================================
      # 2. æ„å»ºå’Œæ¨é€ Docker é•œåƒ
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io

      - name: Extract metadata
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.short_sha }}
            ${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      # ========================================
      # 3. å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
      # ========================================
      - name: Generate .env.production file
        run: |
          mkdir -p secret
          echo "${{ secrets.ENV_PRODUCTION_FILE }}" > secret/.env.production

          if [ ! -f secret/.env.production ]; then
            echo "âŒ Failed to generate .env.production"
            exit 1
          fi

          # éªŒè¯æ–‡ä»¶ä¸ä¸ºç©º
          if [ ! -s secret/.env.production ]; then
            echo "âŒ .env.production is empty"
            exit 1
          fi

          echo "âœ… .env.production generated successfully"

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          source: "docker-compose.yml,nginx.conf,secret/.env.production,script/setup-docker.sh,script/initial_data.py,alembic,alembic.ini"
          target: "/tmp/deploy-${{ github.run_id }}/"
          strip_components: 0
          timeout: 300s

      # ========================================
      # 4. æœåŠ¡å™¨åˆå§‹åŒ–å’Œæ–‡ä»¶éƒ¨ç½²
      # ========================================
      - name: Deploy files and setup server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            DEPLOY_TMP="/tmp/deploy-${{ github.run_id }}"
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            echo "ğŸš€ Starting deployment..."

            # Setup Docker if needed
            if [ -f "$DEPLOY_TMP/script/setup-docker.sh" ]; then
              echo "ğŸ“¦ Setting up Docker..."
              chmod +x "$DEPLOY_TMP/script/setup-docker.sh"
              bash "$DEPLOY_TMP/script/setup-docker.sh"
            elif ! command -v docker &> /dev/null; then
              echo "âŒ Docker not installed and setup script not found"
              exit 1
            fi

            # Verify uploaded files
            echo "ğŸ” Verifying uploaded files..."
            REQUIRED_FILES=(
              "$DEPLOY_TMP/docker-compose.yml"
              "$DEPLOY_TMP/nginx.conf"
              "$DEPLOY_TMP/alembic.ini"
            )

            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "âŒ Required file not found: $file"
                exit 1
              fi
            done

            # Find .env.production
            ENV_FILE=""
            if [ -f "$DEPLOY_TMP/.env.production" ]; then
              ENV_FILE="$DEPLOY_TMP/.env.production"
            elif [ -f "$DEPLOY_TMP/secret/.env.production" ]; then
              ENV_FILE="$DEPLOY_TMP/secret/.env.production"
            else
              echo "âŒ .env.production not found"
              exit 1
            fi

            # Backup existing configuration (if exists)
            if [ -d "$DEPLOY_DIR" ]; then
              BACKUP_DIR="/opt/backups/server-$(date +%Y%m%d-%H%M%S)"
              echo "ğŸ’¾ Backing up current deployment to $BACKUP_DIR"
              sudo mkdir -p "$(dirname "$BACKUP_DIR")"
              sudo cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR/" 2>/dev/null || true
              sudo chown -R ubuntu:ubuntu "$BACKUP_DIR" 2>/dev/null || true
              
              # Keep only last 5 backups
              sudo ls -dt /opt/backups/server-* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf 2>/dev/null || true
            fi

            # Create deployment directories
            echo "ğŸ“ Creating deployment directories..."
            sudo mkdir -p "$DEPLOY_DIR"/{secret,alembic/versions,logs}

            # Deploy configuration files
            echo "ğŸ“„ Deploying configuration files..."
            sudo cp "$DEPLOY_TMP/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            sudo cp "$DEPLOY_TMP/nginx.conf" "$DEPLOY_DIR/nginx.conf"
            sudo cp "$ENV_FILE" "$DEPLOY_DIR/secret/.env.production"

            # Deploy initial_data.py
            if [ -f "$DEPLOY_TMP/script/initial_data.py" ]; then
              sudo cp "$DEPLOY_TMP/script/initial_data.py" "$DEPLOY_DIR/initial_data.py"
              sudo chmod 644 "$DEPLOY_DIR/initial_data.py"
            fi

            # Deploy alembic files
            echo "ğŸ—„ï¸  Deploying alembic files..."
            if [ -d "$DEPLOY_TMP/alembic" ]; then
              sudo cp "$DEPLOY_TMP/alembic/env.py" "$DEPLOY_DIR/alembic/" 2>/dev/null || true
              sudo cp "$DEPLOY_TMP/alembic/script.py.mako" "$DEPLOY_DIR/alembic/" 2>/dev/null || true
              sudo cp "$DEPLOY_TMP/alembic/README" "$DEPLOY_DIR/alembic/" 2>/dev/null || true
              
              # Deploy migration files
              if [ -d "$DEPLOY_TMP/alembic/versions" ]; then
                sudo cp "$DEPLOY_TMP/alembic/versions"/*.py "$DEPLOY_DIR/alembic/versions/" 2>/dev/null || true
                MIGRATION_COUNT=$(ls -1 "$DEPLOY_DIR/alembic/versions"/*.py 2>/dev/null | grep -v __init__ | wc -l || echo "0")
                echo "   Deployed $MIGRATION_COUNT migration file(s)"
              fi
            fi

            sudo cp "$DEPLOY_TMP/alembic.ini" "$DEPLOY_DIR/alembic.ini"

            # Set proper permissions
            echo "ğŸ” Setting permissions..."
            sudo chmod 644 "$DEPLOY_DIR"/{docker-compose.yml,nginx.conf,alembic.ini} 2>/dev/null || true
            sudo chmod 600 "$DEPLOY_DIR/secret/.env.production"
            sudo chown -R ubuntu:ubuntu "$DEPLOY_DIR"

            # Cleanup temporary files
            sudo rm -rf "$DEPLOY_TMP"

            echo "âœ… Deployment files ready"

      # ========================================
      # 5. æ‹‰å–å’Œå¯åŠ¨å®¹å™¨
      # ========================================
      - name: Pull Docker image
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            echo "ğŸ“¥ Pulling Docker image..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            if ! sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" pull; then
              if ! sudo docker-compose -f "$DEPLOY_DIR/docker-compose.yml" pull; then
                echo "âŒ Failed to pull Docker image"
                exit 1
              fi
            fi

            echo "âœ… Docker image pulled successfully"

      - name: Start containers
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 5m
          script: |
            set -e
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"
            COMPOSE_FILE="$DEPLOY_DIR/docker-compose.yml"

            echo "ğŸ”„ Restarting containers..."

            # Validate docker-compose.yml
            if ! sudo docker compose -f "$COMPOSE_FILE" config > /dev/null 2>&1; then
              if ! sudo docker-compose -f "$COMPOSE_FILE" config > /dev/null 2>&1; then
                echo "âŒ Invalid docker-compose.yml"
                exit 1
              fi
            fi

            # å®Œå…¨æ¸…ç†æ—§å®¹å™¨å’Œç›¸å…³èµ„æº
            echo "ğŸ—‘ï¸  Cleaning up old containers..."

            # 1. åœæ­¢å¹¶åˆ é™¤å®¹å™¨
            sudo docker compose -f "$COMPOSE_FILE" down --timeout 30 || \
              sudo docker-compose -f "$COMPOSE_FILE" down --timeout 30 || true

            # 2. å¼ºåˆ¶åˆ é™¤å¯èƒ½æ®‹ç•™çš„å®¹å™¨
            for container in server nginx; do
              if sudo docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "   Removing container: $container"
                sudo docker rm -f "$container" 2>/dev/null || true
              fi
            done

            # 3. æ¸…ç†æ‚¬ç©ºçš„é•œåƒ
            echo "ğŸ§¹ Cleaning up dangling images..."
            sudo docker image prune -f || true

            # 4. éªŒè¯æ¸…ç†ç»“æœ
            echo "ğŸ“Š Verifying cleanup..."
            REMAINING_CONTAINERS=$(sudo docker ps -a --filter "name=server\|nginx" --format "{{.Names}}" | wc -l)
            if [ "$REMAINING_CONTAINERS" -gt 0 ]; then
              echo "âš ï¸  Warning: Found $REMAINING_CONTAINERS remaining containers"
              sudo docker ps -a --filter "name=server\|nginx"
            else
              echo "âœ… All old containers removed"
            fi

            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ Starting new containers..."
            if ! sudo docker compose -f "$COMPOSE_FILE" up -d; then
              if ! sudo docker-compose -f "$COMPOSE_FILE" up -d; then
                echo "âŒ Failed to start containers"
                sudo docker compose -f "$COMPOSE_FILE" logs --tail=100 || true
                exit 1
              fi
            fi

            # ç­‰å¾…å®¹å™¨å¯åŠ¨å¹¶å˜ä¸ºå¥åº·çŠ¶æ€
            echo "â³ Waiting for containers to be healthy..."
            for i in {1..60}; do
              # æ£€æŸ¥å®¹å™¨çŠ¶æ€
              SERVER_STATUS=$(sudo docker inspect --format='{{.State.Status}}' server 2>/dev/null || echo "not_found")
              SERVER_HEALTH=$(sudo docker inspect --format='{{.State.Health.Status}}' server 2>/dev/null || echo "none")
              NGINX_STATUS=$(sudo docker inspect --format='{{.State.Status}}' nginx 2>/dev/null || echo "not_found")
              
              # æ˜¾ç¤ºå½“å‰çŠ¶æ€
              echo "   [$i/60] Server: $SERVER_STATUS ($SERVER_HEALTH), Nginx: $NGINX_STATUS"
              
              # æ£€æŸ¥æ˜¯å¦éƒ½åœ¨è¿è¡Œ
              if [ "$SERVER_STATUS" = "running" ] && [ "$NGINX_STATUS" = "running" ]; then
                # å¦‚æœæ²¡æœ‰å¥åº·æ£€æŸ¥é…ç½®ï¼Œæˆ–è€…å¥åº·æ£€æŸ¥å·²é€šè¿‡
                if [ "$SERVER_HEALTH" = "none" ] || [ "$SERVER_HEALTH" = "healthy" ]; then
                  echo "âœ… Containers are running and healthy"
                  
                  # é¢å¤–éªŒè¯ï¼šç¡®ä¿åº”ç”¨å·²å°±ç»ª
                  echo "â³ Verifying application readiness..."
                  sleep 5
                  
                  if sudo docker exec server test -f /server/.venv/bin/python 2>/dev/null; then
                    echo "âœ… Application is ready"
                    
                    # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
                    echo ""
                    echo "ğŸ“¦ Container status:"
                    sudo docker ps --filter "name=server\|nginx" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                    
                    # æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
                    echo ""
                    echo "ğŸ’» Resource usage:"
                    sudo docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" server nginx
                    
                    break
                  fi
                fi
              fi
              
              # æ£€æŸ¥å®¹å™¨æ˜¯å¦å¼‚å¸¸é€€å‡º
              if [ "$SERVER_STATUS" = "exited" ] || [ "$NGINX_STATUS" = "exited" ]; then
                echo "âŒ Container exited unexpectedly"
                echo ""
                echo "Server logs:"
                sudo docker logs --tail=50 server 2>/dev/null || true
                echo ""
                echo "Nginx logs:"
                sudo docker logs --tail=50 nginx 2>/dev/null || true
                exit 1
              fi
              
              # è¶…æ—¶æ£€æŸ¥
              if [ "$i" -eq 60 ]; then
                echo "âŒ Container failed to start properly after 120 seconds"
                echo ""
                echo "Final status:"
                echo "   Server: $SERVER_STATUS (Health: $SERVER_HEALTH)"
                echo "   Nginx: $NGINX_STATUS"
                echo ""
                echo "Server logs (last 100 lines):"
                sudo docker logs --tail=100 server 2>/dev/null || true
                echo ""
                echo "Nginx logs (last 100 lines):"
                sudo docker logs --tail=100 nginx 2>/dev/null || true
                exit 1
              fi
              
              sleep 2
            done

      # ========================================
      # 6. æ•°æ®åº“è¿ç§»
      # ========================================
      - name: Run database migration
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            echo "ğŸ—„ï¸  Starting database migration..."

            # Verify alembic configuration
            if [ ! -f "$DEPLOY_DIR/alembic.ini" ]; then
              echo "âŒ alembic.ini not found"
              exit 1
            fi

            # Wait for database to be ready (using alembic which handles connection properly)
            echo "â³ Waiting for database connection..."
            for i in {1..30}; do
              # Use alembic to check database connection (it handles async/sync drivers correctly)
              # This works even if database is not initialized yet (will show appropriate error)
              if sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -qE "(Current revision|alembic_version|\(head\)|INFO)" || \
                 sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -q "Can't locate revision"; then
                echo "âœ… Database connection established"
                break
              fi
              
              if [ "$i" -eq 30 ]; then
                echo "âŒ Database connection timeout after 60 seconds"
                echo "   Last alembic output:"
                sudo docker exec server /server/.venv/bin/alembic current 2>&1 || true
                echo "   Check database container status and network connectivity"
                exit 1
              fi
              
              sleep 2
            done

            # Check migration status
            echo "ğŸ“‹ Checking migration status..."
            MIGRATION_FILES=$(sudo ls -1 "$DEPLOY_DIR/alembic/versions"/*.py 2>/dev/null | grep -v __init__ | wc -l || echo "0")
            echo "   Migration files on server: $MIGRATION_FILES"

            # Get current database version
            CURRENT_VERSION_OUTPUT=$(sudo docker exec server /server/.venv/bin/alembic current 2>&1 || echo "")
            DB_INITIALIZED=$(echo "$CURRENT_VERSION_OUTPUT" | grep -qE "(alembic_version|Current revision|\(head\))" && echo "yes" || echo "no")
            DB_CURRENT_VERSION=$(echo "$CURRENT_VERSION_OUTPUT" | grep -oE "[a-f0-9]{12}" | head -1 || echo "")

            echo "   Database initialized: $DB_INITIALIZED"
            [ -n "$DB_CURRENT_VERSION" ] && echo "   Current version: $DB_CURRENT_VERSION"

            # Handle migration scenarios
            if [ "$MIGRATION_FILES" -eq "0" ]; then
              if [ "$DB_INITIALIZED" = "no" ]; then
                echo "ğŸ“ First deployment detected - generating initial migration..."
                echo "âš ï¸  Note: Auto-generated migrations should be reviewed in development first"
                
                if ! sudo docker exec server /server/.venv/bin/alembic revision --autogenerate -m "Initial migration"; then
                  echo "âŒ Failed to generate initial migration"
                  exit 1
                fi
                
                # Copy generated migration back to host
                sudo chown -R ubuntu:ubuntu "$DEPLOY_DIR/alembic/versions/" 2>/dev/null || true
                echo "âœ… Initial migration generated"
              else
                echo "âŒ Critical error: Database is initialized but migration files are missing"
                echo "   Database version: ${DB_CURRENT_VERSION:-unknown}"
                echo ""
                echo "   This indicates a deployment issue. Possible causes:"
                echo "   - Migration files were not committed to git"
                echo "   - Files were not uploaded properly"
                echo "   - Previous deployment used different migration files"
                echo ""
                echo "   Please check: $DEPLOY_DIR/alembic/versions/"
                exit 1
              fi
            fi

            # Get target version
            TARGET_VERSION_OUTPUT=$(sudo docker exec server /server/.venv/bin/alembic heads 2>&1 || echo "")
            TARGET_VERSION=$(echo "$TARGET_VERSION_OUTPUT" | grep -oE "[a-f0-9]{12}" | head -1 || echo "")

            if [ "$DB_INITIALIZED" = "yes" ]; then
              echo "ğŸ“Š Migration plan:"
              echo "   Current: ${DB_CURRENT_VERSION:-unknown}"
              echo "   Target:  ${TARGET_VERSION:-unknown}"
              
              if [ "$DB_CURRENT_VERSION" = "$TARGET_VERSION" ]; then
                echo "   Status:  âœ… Already up to date"
              else
                echo "   Status:  â¬†ï¸  Upgrade required"
              fi
            fi

            # Backup database before migration (optional, for production)
            # Uncomment for production environments
            # echo "ğŸ’¾ Creating database backup..."
            # sudo docker exec db pg_dump -U user dbname > "$DEPLOY_DIR/logs/backup-$(date +%Y%m%d-%H%M%S).sql"

            # Run migration with retry
            echo "ğŸ”„ Running migration..."
            MIGRATION_SUCCESS=false

            for attempt in 1 2 3; do
              echo "   Attempt $attempt/3..."
              
              MIGRATION_OUTPUT=$(sudo docker exec server /server/.venv/bin/alembic upgrade head 2>&1)
              MIGRATION_EXIT=$?
              
              if [ $MIGRATION_EXIT -eq 0 ]; then
                if echo "$MIGRATION_OUTPUT" | grep -q "Running upgrade"; then
                  echo "$MIGRATION_OUTPUT"
                  echo "âœ… Migration completed successfully"
                else
                  echo "âœ… Database is already up to date"
                fi
                MIGRATION_SUCCESS=true
                break
              fi
              
              # Check for version mismatch errors
              if echo "$MIGRATION_OUTPUT" | grep -qE "(Can't locate revision|Multiple heads|target database is not up to date)"; then
                echo "âŒ Version mismatch detected:"
                echo "$MIGRATION_OUTPUT"
                echo ""
                echo "   Database version: ${DB_CURRENT_VERSION:-unknown}"
                echo "   Target version:   ${TARGET_VERSION:-unknown}"
                echo ""
                echo "   This error indicates:"
                echo "   - Database has a version not in current migration files"
                echo "   - Migration history is inconsistent"
                echo "   - Database was migrated with different migration files"
                echo ""
                echo "   Manual intervention required. Check migration history:"
                sudo docker exec server /server/.venv/bin/alembic history
                exit 1
              fi
              
              # Retry on other errors
              if [ "$attempt" -lt 3 ]; then
                echo "   Migration failed, retrying in 5 seconds..."
                echo "$MIGRATION_OUTPUT"
                sleep 5
              else
                echo "âŒ Migration failed after 3 attempts"
                echo "$MIGRATION_OUTPUT"
                echo ""
                echo "Current database state:"
                sudo docker exec server /server/.venv/bin/alembic current
                echo ""
                echo "Recent logs:"
                sudo docker logs --tail=100 server
                exit 1
              fi
            done

            # Verify migration success
            if [ "$MIGRATION_SUCCESS" = true ]; then
              NEW_VERSION=$(sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -oE "[a-f0-9]{12}" | head -1 || echo "")
              echo "ğŸ“Œ Final database version: ${NEW_VERSION:-unknown}"
            fi

      # ========================================
      # 7. åˆå§‹åŒ–æ•°æ®
      # ========================================
      - name: Insert initial data
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            echo "ğŸ“Š Inserting initial data..."

            # Verify script exists
            if [ ! -f "$DEPLOY_DIR/initial_data.py" ]; then
              echo "âš ï¸  initial_data.py not found, skipping"
              exit 0
            fi

            # Verify script is accessible in container
            if ! sudo docker exec server test -f /server/script/initial_data.py; then
              echo "âŒ Script not accessible in container"
              exit 1
            fi

            # Run initial data script with retry
            for attempt in 1 2 3; do
              echo "   Attempt $attempt/3..."
              
              # Set PYTHONPATH to /server so Python can find the 'app' module
              if sudo docker exec -e PYTHONPATH=/server -w /server server /server/.venv/bin/python /server/script/initial_data.py; then
                echo "âœ… Initial data inserted successfully"
                exit 0
              fi
              
              if [ "$attempt" -lt 3 ]; then
                echo "   Failed, retrying in 3 seconds..."
                sleep 3
              else
                echo "âŒ Failed to insert initial data after 3 attempts"
                echo ""
                echo "Recent logs:"
                sudo docker logs --tail=100 server
                exit 1
              fi
            done

      # ========================================
      # 8. å¥åº·æ£€æŸ¥
      # ========================================
      - name: Health check
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ¥ Starting health check..."
            echo "   URL: ${{ env.HEALTH_CHECK_URL }}"
            echo "   Max attempts: ${{ env.MAX_HEALTH_CHECK_ATTEMPTS }}"

            # Initial wait for service to initialize
            sleep 10

            for i in $(seq 1 ${{ env.MAX_HEALTH_CHECK_ATTEMPTS }}); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.HEALTH_CHECK_URL }}" 2>/dev/null || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Service is healthy (HTTP $HTTP_CODE)"
                
                # Additional checks
                echo ""
                echo "ğŸ“Š Deployment summary:"
                echo "   Docker image: ${{ env.DOCKER_IMAGE }}:latest"
                echo "   Commit: ${{ github.sha }}"
                echo "   Deployed at: $(date)"
                
                # Show running containers
                echo ""
                echo "ğŸ“¦ Running containers:"
                sudo docker ps --filter "name=server\|nginx" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                
                exit 0
              fi
              
              echo "â³ Waiting... ($i/${{ env.MAX_HEALTH_CHECK_ATTEMPTS }}) - HTTP $HTTP_CODE"
              
              if [ "$i" -lt "${{ env.MAX_HEALTH_CHECK_ATTEMPTS }}" ]; then
                sleep ${{ env.HEALTH_CHECK_INTERVAL }}
              fi
            done

            echo ""
            echo "âŒ Health check failed after ${{ env.MAX_HEALTH_CHECK_ATTEMPTS }} attempts"
            echo ""
            echo "ğŸ“‹ Diagnostics:"

            # Container status
            echo ""
            echo "Container status:"
            sudo docker ps -a --filter "name=server\|nginx" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # Server logs
            echo ""
            echo "Server logs (last 100 lines):"
            sudo docker logs --tail=100 server 2>/dev/null || echo "Failed to get server logs"

            # Nginx logs
            echo ""
            echo "Nginx logs (last 50 lines):"
            sudo docker logs --tail=50 nginx 2>/dev/null || echo "Failed to get nginx logs"

            # Network check
            echo ""
            echo "Network connectivity:"
            curl -v "${{ env.HEALTH_CHECK_URL }}" 2>&1 | head -20 || true

            exit 1

      # ========================================
      # 9. æ¸…ç†
      # ========================================
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -rf secret/
          echo "âœ… Cleanup completed"

      # ========================================
      # 10. é€šçŸ¥
      # ========================================
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment completed successfully"
            echo "ğŸš€ Application is now running at ${{ env.HEALTH_CHECK_URL }}"
          else
            echo "âŒ Deployment failed"
            echo "ğŸ“‹ Check the logs above for details"
          fi
