name: Deploy App Server

on:
  workflow_run:
    workflows: ["Deploy DB Server"]
    types:
      - completed
    branches:
      - main

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/server
  DEPLOY_DIR: /opt/server
  HEALTH_CHECK_URL: https://api.heyxiaoli.com

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify required files
        run: |
          for file in docker-compose.yml nginx.conf alembic.ini alembic/env.py script/initial_data.py; do
            [ -f "$file" ] || { echo "‚ùå Missing: $file"; exit 1; }
          done
          echo "‚úÖ All required files verified"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate .env.production file
        run: |
          mkdir -p secret
          echo "${{ secrets.ENV_PRODUCTION_FILE }}" > secret/.env.production
          [ -s secret/.env.production ] || { echo "‚ùå .env.production is empty"; exit 1; }

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          source: "docker-compose.yml,nginx.conf,secret/.env.production,script/setup-docker.sh,script/initial_data.py,alembic,alembic.ini"
          target: "/tmp/deploy-${{ github.run_id }}/"
          timeout: 300s

      - name: Deploy and start containers
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e
            DEPLOY_TMP="/tmp/deploy-${{ github.run_id }}"
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            # Setup Docker if needed
            if [ -f "$DEPLOY_TMP/script/setup-docker.sh" ]; then
              chmod +x "$DEPLOY_TMP/script/setup-docker.sh"
              bash "$DEPLOY_TMP/script/setup-docker.sh"
            fi

            # Find .env.production
            ENV_FILE="$DEPLOY_TMP/secret/.env.production"
            [ -f "$ENV_FILE" ] || ENV_FILE="$DEPLOY_TMP/.env.production"
            [ -f "$ENV_FILE" ] || { echo "‚ùå .env.production not found"; exit 1; }

            # Backup existing deployment
            if [ -d "$DEPLOY_DIR" ]; then
              BACKUP_DIR="/opt/backups/server-$(date +%Y%m%d-%H%M%S)"
              sudo mkdir -p "$(dirname "$BACKUP_DIR")"
              sudo cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR/" 2>/dev/null || true
              sudo ls -dt /opt/backups/server-* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf 2>/dev/null || true
            fi

            # Create directories and deploy files
            sudo mkdir -p "$DEPLOY_DIR"/{secret,alembic/versions,logs}
            sudo cp "$DEPLOY_TMP/docker-compose.yml" "$DEPLOY_DIR/"
            sudo cp "$DEPLOY_TMP/nginx.conf" "$DEPLOY_DIR/"
            sudo cp "$ENV_FILE" "$DEPLOY_DIR/secret/.env.production"
            sudo cp "$DEPLOY_TMP/alembic.ini" "$DEPLOY_DIR/"
            [ -f "$DEPLOY_TMP/script/initial_data.py" ] && sudo cp "$DEPLOY_TMP/script/initial_data.py" "$DEPLOY_DIR/"

            # Deploy alembic files
            if [ -d "$DEPLOY_TMP/alembic" ]; then
              sudo cp -r "$DEPLOY_TMP/alembic"/* "$DEPLOY_DIR/alembic/" || { echo "‚ùå Failed to copy alembic files"; exit 1; }
              echo "‚úÖ Alembic files deployed"
            else
              echo "‚ö†Ô∏è  No alembic directory found"
            fi

            # Set permissions
            sudo chmod 600 "$DEPLOY_DIR/secret/.env.production"
            sudo chown -R ubuntu:ubuntu "$DEPLOY_DIR"
            sudo rm -rf "$DEPLOY_TMP"

            # Pull and start containers
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" pull || sudo docker-compose -f "$DEPLOY_DIR/docker-compose.yml" pull
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" down --timeout 30 || true
            sudo docker image prune -f || true
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" up -d || sudo docker-compose -f "$DEPLOY_DIR/docker-compose.yml" up -d

            # Wait for containers
            for i in {1..30}; do
              SERVER_STATUS=$(sudo docker inspect --format='{{.State.Status}}' server 2>/dev/null || echo "not_found")
              NGINX_STATUS=$(sudo docker inspect --format='{{.State.Status}}' nginx 2>/dev/null || echo "not_found")
              [ "$SERVER_STATUS" = "running" ] && [ "$NGINX_STATUS" = "running" ] && break
              [ "$i" -eq 30 ] && { echo "‚ùå Containers failed to start"; sudo docker logs --tail=50 server; exit 1; }
              sleep 2
            done
            echo "‚úÖ Containers started"

      - name: Run database migration
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e

            # Wait for database connection
            echo "‚è≥ Waiting for database..."
            for i in {1..30}; do
              sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -qE "(revision|alembic_version|\(head\)|INFO)" && break
              [ "$i" -eq 30 ] && { echo "‚ùå Database connection timeout"; exit 1; }
              sleep 2
            done

            # Check current database version
            CURRENT_VERSION=$(sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -oP '(?<=\(head\) )[a-f0-9]+' || echo "none")
            
            if [ "$CURRENT_VERSION" = "none" ]; then
              # Fresh database - generate and apply initial migration
              echo "üìù Fresh database detected, generating initial migration..."
              sudo docker exec server /server/.venv/bin/alembic revision --autogenerate -m "Initial migration"
              sudo docker exec server /server/.venv/bin/alembic upgrade head
              echo "‚úÖ Initial migration completed"
            else
              # Existing database - check for schema changes
              echo "üìù Database at version $CURRENT_VERSION, checking for schema changes..."
              
              # Generate migration to detect changes
              sudo docker exec server /server/.venv/bin/alembic revision --autogenerate -m "Update schema $(date +%Y%m%d_%H%M%S)"
              
              # Check if migration has actual changes
              MIGRATION_FILE=$(sudo docker exec server find /server/alembic/versions -name "*.py" ! -name "__init__.py" -type f | head -1)
              HAS_CHANGES=$(sudo docker exec server grep -E "def upgrade|op\." "$MIGRATION_FILE" | grep -v "pass" | wc -l)
              
              if [ "$HAS_CHANGES" -gt 2 ]; then
                # Has actual schema changes - apply migration
                echo "‚ö†Ô∏è  Schema changes detected, applying migration..."
                sudo docker exec server /server/.venv/bin/alembic upgrade head
                echo "‚úÖ Migration applied successfully"
              else
                # No changes - just update version
                echo "‚úÖ No schema changes detected, updating version only..."
                sudo docker exec server /server/.venv/bin/alembic stamp head
              fi
            fi

      - name: Insert initial data
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            [ -f "${{ env.DEPLOY_DIR }}/initial_data.py" ] || exit 0
            sudo docker exec -e PYTHONPATH=/server -w /server server /server/.venv/bin/python /server/script/initial_data.py
            echo "‚úÖ Initial data inserted"

      - name: Health check
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            sleep 10
            for i in {1..6}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.HEALTH_CHECK_URL }}" 2>/dev/null || echo "000")
              [ "$HTTP_CODE" = "200" ] && { echo "‚úÖ Health check passed"; exit 0; }
              echo "Waiting... ($i/6) - HTTP $HTTP_CODE"
              sleep 5
            done
            echo "‚ùå Health check failed"
            sudo docker logs --tail=50 server
            exit 1

      - name: Cleanup
        if: always()
        run: rm -rf secret/
